
<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <style type="text/css">
    #info {
  position: absolute;
  top: 2%;
  width: 100%;
  padding: 10px;
  text-align: center;
  color: #ffff00
}
body {
  overflow: hidden;
}
  </style>
  <title>HW3 by hk006008</title>  
</head>
<body>
  <div id="info">My Second Three.js
  <br/> turning, buttons, orbitControls, resize
  <br/>
  <p id='thetaPrint'>
  </p>
  <button id="toggle" style="width:20%">Toggle Turn</button>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r70/three.min.js"></script>
<script src="https://dl.dropboxusercontent.com/u/3587259/Code/Threejs/OrbitControls.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://jyunming-chen.github.io/tutsplus/js/KeyboardState.js"></script>
<script type='text/javascript'>

var scene, renderer, camera;
var controls;
var car, Wheel1, Wheel2, Wheel3, Wheel3D;
var keyboard = new KeyboardState();
var theta = 0.001;
var thetaP, vP;
var C, RC;
var v = 0;
var rectangle, circle, cylinders = [];
var mouse = new THREE.Vector2();

init();
animate();
///////////////////////////////////////////////
function checkIntersect(rect, circle) {
  var rad2 = circle.r * circle.r;
  var max = rect.max.clone().sub(circle.c);
  var min = rect.min.clone().sub(circle.c);
  
  if (max.x < 0) {
  	if (max.y < 0)
    	return (max.x * max.x + max.y * max.y < rad2);
    else if (min.y > 0)
    	return (max.x * max.x + min.y * min.y < rad2);
    else
    	return (Math.abs(max.x) < circle.r);
  } else if (min.x > 0) {
  	if (max.y < 0)
    	return (min.x * min.x + max.y * max.y < rad2);
    else if (min.y > 0)
    	return (min.x * min.x + min.y * min.y < rad2);
    else
    	return (min.x < circle.r);
  } else {
  	if (max.y < 0)
    	return (Math.abs(max.y) < circle.r);
    else if (min.y > 0)
    	return (min.y < circle.r);
    else
    	return true;
  }
}
function cylinderTest() {
  for (var i = 0; i < cylinders.length; i++) {
    var cylinder = cylinders[i];
    //var c = car.worldToLocal(cylinder.position.clone());
    var rect = {};
    rect.max = new THREE.Vector2(car.position.x + 20, car.position.z + 10);
    rect.min = new THREE.Vector2(car.position.x - 20, car.position.z - 10);
    /*rect.max = new THREE.Vector3(c.x + 20, c.z + 10);
    rect.min = new THREE.Vector3(c.x - 20, c.z - 10);
    rect.max = car.position.clone().add (new THREE.Vector3(20,0,10));
    rect.min = car.position.clone().sub (new THREE.Vector3(20,0,10));*/
    var o;
    //o = new THREE.Vector2(cylinder.position.x, cylinder.position.z);
    var circ = 
      {c : new THREE.Vector2(cylinder.position.x, cylinder.position.z), r : 5}
    ;
    //var circ = 5;
    var hit = checkIntersect (rect, circ);
    if (hit) {
        cylinder.material.color.set('red');
        return true;
      } else {
        cylinder.material.color.set('blue');
      }/**/
  }
  return false;
}
/////////////////////////////////////////////////
$("#toggle").click(function() {
  turn = !turn;
});

function init() {
  scene = new THREE.Scene();
  renderer = new THREE.WebGLRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.setClearColor(0x888888);
  document.body.appendChild(renderer.domElement);

  camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1, 1000);
  camera.position.z = 500;
  controls = new THREE.OrbitControls(camera, renderer.domElement);
///////////////////////////////////////////////////////////////////////////////
  Wheel1 = new THREE.Mesh(new THREE.CylinderGeometry(6, 6, 3, 8), new THREE.MeshBasicMaterial({
    wireframe:true
  }));
  Wheel1.rotation.x = Math.PI / 2;
  Wheel1.position.set(-13, 4, 10); 
  
  Wheel2 = new THREE.Mesh(new THREE.CylinderGeometry(6, 6, 3, 8), new THREE.MeshBasicMaterial({
    wireframe:true
  }));
  Wheel2.rotation.x = Math.PI / 2;
  Wheel2.position.set(-13, 4, -10); 
  
  Wheel3 = new THREE.Mesh(new THREE.CylinderGeometry(6, 6, 3, 8), new THREE.MeshBasicMaterial({
    wireframe:true
  }));
  Wheel3.rotation.x = Math.PI / 2;
  //Wheel3.position.set(10, 4, 0); 
  Wheel3D = new THREE.Object3D();
  Wheel3D.add (Wheel3);
  Wheel3D.position.set(10, 4, 0);
///////////////////////////////////////////////////////////////////////
  var geometry = new THREE.BoxGeometry(40, 16, 20);
  var material = new THREE.MeshBasicMaterial({
    wireframe: 1
  });
  
  thetaP = window.document.getElementById('thetaPrint');
  var mesh = new THREE.Mesh(geometry, material);
  //mesh.position.set(0, 2, 0);/////////////////
  car = new THREE.Object3D();
  car.add (mesh);
  car.add (Wheel1);///////////////////////
  car.add (Wheel2);///////////////////////
  car.add (Wheel3D);///////////////////////
  mesh.position.y = 12;
  scene.add(car);

  var gridXZ = new THREE.GridHelper(500, 10);
  gridXZ.setColors(new THREE.Color(0xff0000), new THREE.Color(0xffffff));
  scene.add(gridXZ);

  window.addEventListener('resize', onWindowResize, false);///////////
  ////////////////////
  RCmesh = new THREE.Mesh (new THREE.SphereGeometry(5,6,6), new THREE.MeshBasicMaterial());
  scene.add (RCmesh);
	C = new THREE.Vector3();
  ///////////////////////////////////////////////////////////////////
  circle = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 20, 10), new THREE.MeshBasicMaterial({
    color: 'blue', wireframe:1
  }));
  circle.position.set(62,10,-30);
  scene.add(circle);
  cylinders.push(circle);
  circle1 = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 20, 10), new THREE.MeshBasicMaterial({
    color: 'blue', wireframe:1
  }));
  circle1.position.set(62,10,30);
  scene.add(circle1);
  cylinders.push(circle1);
  circle2 = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 20, 10), new THREE.MeshBasicMaterial({
    color: 'blue', wireframe:1
  }));
  circle2.position.set(122,10,-50);
  scene.add(circle2);
  cylinders.push(circle2);
  circle3 = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 20, 10), new THREE.MeshBasicMaterial({
    color: 'blue', wireframe:1
  }));
  circle3.position.set(122,10,10);
  scene.add(circle3);
  cylinders.push(circle3);
  circle4 = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 20, 10), new THREE.MeshBasicMaterial({
    color: 'blue', wireframe:1
  }));
  circle4.position.set(182,10,-30);
  scene.add(circle4);
  cylinders.push(circle4);
  circle5 = new THREE.Mesh(new THREE.CylinderGeometry(5, 5, 20, 10), new THREE.MeshBasicMaterial({
    color: 'blue', wireframe:1
  }));
  circle5.position.set(182,10,30);
  scene.add(circle5);
  cylinders.push(circle5);
}

function onWindowResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

function animate() {
	keyboard.update();
  if(cylinderTest())
  	v = 0;
  if (keyboard.pressed ("right") && theta < 0.8){
  	theta += 0.04;
    Wheel3D.rotation.y = -theta;
  }
  else if (keyboard.pressed("left") && theta > -0.8){
  	theta -= 0.04;
    Wheel3D.rotation.y = -theta;
  }
	thetaP.innerHTML = -Wheel1.rotation.y.toFixed (3);
  //vP.innerHTML = v.toFixed(3);
  
  RC = car.localToWorld (new THREE.Vector3(-12,0,24/Math.tan(theta)));
  RCmesh.position.copy (RC);
  
  //var v = 0;
  if(keyboard.pressed("down") && v < 50){
  	v += 3;
    /*Wheel1.rotation.y += v;
    Wheel2.rotation.y += v;
    Wheel3.rotation.y += v;*/
  }
  else if(keyboard.pressed("up") && v > -50){
  	v -= 3;
    /*Wheel1.rotation.y += v;
    Wheel2.rotation.y += v;
    Wheel3.rotation.y += v;*/
  }
    
    
  var omega = v * Math.tan(theta)/24;
  var deltaT = 0.05;
  var vv = C.clone().sub(RC).applyAxisAngle (new THREE.Vector3(0,1,0), omega*deltaT);
  C = vv.add(RC);
  car.position.copy(C);
  car.rotation.y += omega*deltaT;
  
  var rota = omega * deltaT * 2;
  //if(rota > 0)	rota = rota*-1;
  Wheel1.rotation.y += v * 0.005;
  Wheel2.rotation.y += v * 0.005;
  Wheel3.rotation.y += v * 0.005;
  
  controls.update();

camera.lookAt (C);

requestAnimationFrame(animate);
  renderer.render(scene, camera);
}
</script>
</body>
</html>

